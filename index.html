<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROMOPAPI • ROMOPAPI</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="ROMOPAPI">
<meta property="og:description" content="ROMOPAPI provides an API to access OMOP CDM databases. It includes functions for creating code counts tables, atomic code counts tables, and observation counts tables. The package supports both local SQLite databases and remote database connections through DBI.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">ROMOPAPI</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/use_cases.html">use_cases</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/javier-gracia-tabuenca-tuni/ROMOPAPI/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="romopapi">ROMOPAPI<a class="anchor" aria-label="anchor" href="#romopapi"></a>
</h1></div>
<p>API to access OMOP CDM (Observational Medical Outcomes Partnership Common Data Model) database</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install ROMOPAPI from GitHub with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"FINNGEN/ROMOPAPI"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<div class="section level3">
<h3 id="running-the-api-server-with-the-default-testing-database">Running the API Server with the default testing database<a class="anchor" aria-label="anchor" href="#running-the-api-server-with-the-default-testing-database"></a>
</h3>
<p>The simplest way to start the API server is:</p>
<p>Create a folder to store the testing databases. This saves time as the databases dont have to be downloaded every time the API server is started.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/javier-gracia-tabuenca-tuni/ROMOPAPI" class="external-link">ROMOPAPI</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the API server with default settings (uses internal testing database with minimal data)</span></span>
<span><span class="fu"><a href="reference/runApiServer.html">runApiServer</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This will start the API server on port 8585.</p>
<div class="section level4">
<h4 id="testing-endpoints">Testing endpoints<a class="anchor" aria-label="anchor" href="#testing-endpoints"></a>
</h4>
<p>The main endpoint for testing is: <a href="http://127.0.0.1:8585/report?conceptId=" class="external-link uri">http://127.0.0.1:8585/report?conceptId=</a><concept_id></concept_id></p>
<p>For example, <a href="http://127.0.0.1:8585/report?conceptId=317009" class="external-link uri">http://127.0.0.1:8585/report?conceptId=317009</a></p>
<p>This will return an HTML report for the concept id 317009.</p>
</div>
<div class="section level4">
<h4 id="production-endpoints">Production endpoints<a class="anchor" aria-label="anchor" href="#production-endpoints"></a>
</h4>
<p>The main endpoint for production is: <a href="http://127.0.0.1:8585/getCodeCounts?conceptId=" class="external-link uri">http://127.0.0.1:8585/getCodeCounts?conceptId=</a><concept_id></concept_id></p>
<p>This will return the code counts for the concept ids 317009.</p>
<p>Separated in 3 tables:</p>
<ul>
<li>
<code>concept_relationship</code>: relationships between conceptIds</li>
<li>
<code>concept</code>: information about the conceptIds</li>
<li>
<code>stratified_code_counts</code>: patient counts by conceptId stratified by gender, year, and age decile</li>
</ul>
<p>See the API documentation for more details: <a href="http://127.0.0.1:8585/__docs__/" class="external-link uri">http://127.0.0.1:8585/__docs__/</a></p>
</div>
</div>
<div class="section level3">
<h3 id="running-the-api-server-with-a-custom-database">Running the API Server with a custom database<a class="anchor" aria-label="anchor" href="#running-the-api-server-with-a-custom-database"></a>
</h3>
<p>Create a custom database configuration.</p>
<p>Create a yaml file with the database configuration.</p>
<p>For example, <code>database_config.yml</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">cohortTableHandler</span><span class="kw">:</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="at">    </span><span class="fu">database</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="at">      </span><span class="fu">databaseId</span><span class="kw">:</span><span class="at"> F1</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="at">      </span><span class="fu">databaseName</span><span class="kw">:</span><span class="at"> FinnGen</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="at">      </span><span class="fu">databaseDescription</span><span class="kw">:</span><span class="at"> Eunomia database FinnGen</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="at">    </span><span class="fu">connection</span><span class="kw">:</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="at">      </span><span class="fu">connectionDetailsSettings</span><span class="kw">:</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="at">          </span><span class="fu">dbms</span><span class="kw">:</span><span class="at"> sqlite</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="at">          </span><span class="fu">server</span><span class="kw">:</span><span class="at"> &lt;pathToFinnGenEunomiaSqlite&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="at">    </span><span class="fu">cdm</span><span class="kw">:</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="at">        </span><span class="fu">cdmDatabaseSchema</span><span class="kw">:</span><span class="at"> main</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="at">        </span><span class="fu">vocabularyDatabaseSchema</span><span class="kw">:</span><span class="at"> main</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="at">        </span><span class="fu">resultsDatabaseSchema</span><span class="kw">:</span><span class="at"> main</span></span></code></pre></div>
<p>If it is the first time running the API server with the custom database, you need add the parameter <code>buildCountsTable = TRUE</code> to the <code>runApiServer</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">databaseConfig</span> <span class="op">&lt;-</span> <span class="fu">yaml</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/yaml/man/read_yaml.html" class="external-link">read_yaml</a></span><span class="op">(</span><span class="st">"path/to/database_config.yml"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ROMOPAPI</span><span class="fu">::</span><span class="fu"><a href="reference/runApiServer.html">runApiServer</a></span><span class="op">(</span></span>
<span>  cohortTableHandlerConfig <span class="op">=</span> <span class="va">databaseConfig</span><span class="op">$</span><span class="va">cohortTableHandler</span>,</span>
<span>  buildCountsTable <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level1">
<h1 id="development">DEVELOPMENT<a class="anchor" aria-label="anchor" href="#development"></a>
</h1>
<div class="section level2">
<h2 id="run-api-with-atlasdevelopment">Run API with AtlasDevelopment<a class="anchor" aria-label="anchor" href="#run-api-with-atlasdevelopment"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/javier-gracia-tabuenca-tuni/ROMOPAPI" class="external-link">ROMOPAPI</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">databasesConfig</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/HadesExtras_readAndParseYaml.html">HadesExtras_readAndParseYaml</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata"</span>, <span class="st">"config"</span>, <span class="st">"atlasDev_databasesConfig.yml"</span>, package <span class="op">=</span> <span class="st">"ROMOPAPI"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">bigrquery</span><span class="fu">::</span><span class="fu"><a href="https://bigrquery.r-dbi.org/reference/bq_auth.html" class="external-link">bq_auth</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GCP_SERVICE_KEY"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Run the API server with default settings (uses test FinnGen Eunomia database)</span></span>
<span><span class="fu"><a href="reference/runApiServer.html">runApiServer</a></span><span class="op">(</span>cohortTableHandlerConfig <span class="op">=</span> <span class="va">databasesConfig</span><span class="op">$</span><span class="va">BQ5k</span><span class="op">$</span><span class="va">cohortTableHandler</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="api-return-values">API return values<a class="anchor" aria-label="anchor" href="#api-return-values"></a>
</h1>
<div class="section level2">
<h2 id="getcodecounts">getCodeCounts<a class="anchor" aria-label="anchor" href="#getcodecounts"></a>
</h2>
<p>Based on the example output, getCodeCounts returns a list with 3 components:</p>
<ol style="list-style-type: decimal">
<li>concept_relationships - A tibble containing:
<ul>
<li>parent_concept_id: 🔑 Parent concept ID</li>
<li>child_concept_id: 🔑 Child concept ID</li>
<li>levels: Hierarchy level information (e.g. “-1”, “0”, “1-1”, “2-2”, “3-3”, “Mapped from”)</li>
<li>“-1” means the child is a parent of the root concept</li>
<li>“0” means the concept is the root of the hierarchy</li>
<li>“n-n” means the child is n levels below the parent in the hierarchy</li>
<li>“Mapped from” means the child is mapped from another vocabulary</li>
<li>“Maps to” means the child is mapped to another vocabulary</li>
<li>concept_class_id: Type of concept (e.g. “Clinical Finding”, “ICD10 code”)</li>
</ul>
</li>
<li>stratified_code_counts - A tibble containing:
<ul>
<li>concept_id: 🔑Concept identifier</li>
<li>calendar_year: Year of the counts</li>
<li>gender_concept_id: Gender concept ID</li>
<li>age_decile: Age group by decade</li>
<li>node_record_counts: Number of events for this specific concept</li>
<li>node_descendant_record_counts: Number of events including descendant concepts</li>
</ul>
</li>
<li>concepts - A tibble containing concept :
<ul>
<li>concept_id: 🔑 Concept identifier</li>
<li>concept_name: Name/description of the concept</li>
<li>domain_id: Domain the concept belongs to (e.g. “Condition”)</li>
<li>vocabulary_id: Source vocabulary (e.g. “SNOMED”, “ICD10”)</li>
<li>concept_class_id: Type of concept (e.g. “Clinical Finding”, “ICD10 code”)</li>
<li>standard_concept: Boolean indicating if this is a standard concept</li>
<li>concept_code: Original code in source vocabulary</li>
<li>record_counts: Number of events for this specific concept</li>
<li>descendant_record_counts: Number of events including descendant concepts</li>
</ul>
</li>
</ol>
</div>
</div>
<div class="section level1">
<h1 id="docker">Docker<a class="anchor" aria-label="anchor" href="#docker"></a>
</h1>
<div class="section level2">
<h2 id="existing-docker-image">Existing docker image<a class="anchor" aria-label="anchor" href="#existing-docker-image"></a>
</h2>
<p>Existing docker image is available at: <a href="https://hub.docker.com/repository/docker/javiergrata/romopapi/" class="external-link uri">https://hub.docker.com/repository/docker/javiergrata/romopapi/</a></p>
<pre><code>docker run -p 8585:8585 javiergrata/romopapi</code></pre>
</div>
<div class="section level2">
<h2 id="build-the-docker-image">Build the docker image<a class="anchor" aria-label="anchor" href="#build-the-docker-image"></a>
</h2>
<p>A GITHUBPAT.txt file with the GitHub personal access token is needed in the root of the repository.</p>
<pre><code>docker build --secret id=build_github_pat,src=GITHUBPAT.txt -t romopapi .</code></pre>
<p>Optionally, the ROMOPAPI_BRANCH can be set to the branch to be used the BUILD_CACHE_BUSTER can be set current time to force a rebuild of changes in the repository.</p>
<pre><code>docker build --secret id=build_github_pat,src=GITHUBPAT.txt --build-arg ROMOPAPI_BRANCH=main --build-arg BUILD_CACHE_BUSTER=$(date +%s) -t romopapi .</code></pre>
</div>
<div class="section level2">
<h2 id="run-the-docker-container">Run the docker container<a class="anchor" aria-label="anchor" href="#run-the-docker-container"></a>
</h2>
<pre><code>docker run -p 8585:8585 romopapi</code></pre>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/javier-gracia-tabuenca-tuni/ROMOPAPI/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/javier-gracia-tabuenca-tuni/ROMOPAPI/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing ROMOPAPI</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Javier Gracia-Tabuenca <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/YOUR-ORCID-ID" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Javier Gracia-Tabuenca.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
