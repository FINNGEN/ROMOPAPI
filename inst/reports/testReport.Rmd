---
title: "Dynamic Report"
output: html_document
params:
  conceptId: NULL
  CDMdbHandler: NULL
  showsMappings: FALSE
  pruneLevels: NULL
  pruneClass: NULL
---

```{r setup, include=FALSE}

conceptId <- params$conceptId |> as.integer()
CDMdbHandler <- params$CDMdbHandler
showsMappings <- params$showsMappings
pruneLevels <- params$pruneLevels 
pruneClass <- params$pruneClass

# Set dynamic title based on conceptId parameter
if (!is.null(conceptId)) {
  title <- paste("Concept ID:", conceptId, "showsMappings:", showsMappings, "pruneLevels:", pruneLevels)
} else {
  title <- "Dynamic Report"
}

```

# `r title`
  
```{r}
results <- getCodeCounts_memoise(
  CDMdbHandler,
  conceptId = conceptId
)

if (pruneLevels != 0L | pruneClass != '') {
  results <- pruneLevelsFromResults(results, pruneLevels, pruneClass = pruneClass)
}
``` 


Graph
```{r}
mermaid <- createMermaidGraphFromResults(results, showsMappings = showsMappings)
DiagrammeR::mermaid(mermaid, width = "100%", height = "100%")
```

Table
```{r}
createCodeCountsTableFromResults(results)
``` 

Plot
```{r}
createPlotFromResults(results, showsMappings = showsMappings, width = 1000, height = 1000)
``` 


<!-- Load mermaid.js -->
<script src="mermaid.min.js"></script>
<script>
mermaid.initialize({ startOnLoad: true });
</script>

